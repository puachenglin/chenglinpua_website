<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chenglin Pua - Research</title>
    <meta name="description" content="Chenglin Pua research portfolio covering advanced electron microscopy, multi-slice electron ptychography (MEP), and materials science projects.">
    <meta name="keywords" content="research, science, electron ptychography, microscopy, academic portfolio, journal, dataset, youtube, MEP">
    <meta name="author" content="Chenglin Pua">
    <link rel="icon" href="https://placehold.co/32x32/1D4ED8/FFFFFF?text=P">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }
        /* Custom scrollbar style for modern browsers */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .content-editable-field:hover {
            /* Highlight editable fields with the current theme color */
            outline: 2px solid var(--theme-color-500, #3b82f6);
            cursor: text;
        }
        /* Utility class for preview content truncation - not used here, but kept for consistency */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }

        /* Magnification on Hover */
        .magnify-on-hover {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s;
        }
        .magnify-on-hover:hover {
            transform: scale(1.05); /* 5% magnification */
            z-index: 10; /* Bring to front */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Soft shadow for depth */
        }
        
        /* NEW: PPT Longstyle (4:1 Aspect Ratio) */
        .aspect-16-4 {
            aspect-ratio: 16 / 4;
        }
        /* Ensure images inside a constrained aspect ratio container cover it */
        .figure-longstyle img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Use cover for the long style figure */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="shadow-lg sticky top-0 z-50 transition-colors duration-300" id="header" style="background-color: var(--theme-color-800, #1e40af);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-4">
            <h1 class="text-3xl font-extrabold tracking-tight text-white">Chenglin Pua</h1>
            <nav class="hidden md:flex space-x-6">
                <a href="../" class="text-white hover:text-opacity-80 transition duration-150 font-medium">Home</a>
                <a href="./" class="text-white hover:text-opacity-80 transition duration-150 font-medium">Research</a>
                <a href="../personal/" class="text-white hover:text-opacity-80 transition duration-150 font-medium">Personal Life</a>
                <a href="../gallery/" class="text-white hover:text-opacity-80 transition duration-150 font-medium">Gallery</a>
                <a href="../articles/" class="text-white hover:text-opacity-80 transition duration-150 font-medium">Articles</a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="md:grid md:grid-cols-4 md:gap-8">
            
            <div class="md:col-span-1 mb-8 md:mb-0">
                <div id="profile-sidebar" class="sticky top-24 bg-white p-6 rounded-xl shadow-lg">
                    <div id="profile-sidebar-content"></div>
                </div>
            </div>

            <div class="md:col-span-3 space-y-20" id="main-content-wrapper">
                
                <div id="loading-indicator" class="text-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto" style="border-color: var(--theme-color-600, #4f46e5);"></div>
                    <p class="mt-4 text-lg text-gray-600">Loading website content...</p>
                </div>

                <section id="research-section" class="scroll-mt-24"></section>
                
                <section id="education-section" class="scroll-mt-24 hidden"></section>
                <section id="presentations-section" class="scroll-mt-24 hidden"></section>
                <section id="awards-section" class="scroll-mt-24 hidden"></section>
                <section id="personal-section" class="scroll-mt-24 hidden"></section>
                <section id="gallery-section" class="scroll-mt-24 hidden"></section>
                <section id="articles-section" class="scroll-mt-24 hidden"></section>
            </div>
        </div>
    </main>

    <footer class="mt-16 py-8" style="background-color: var(--theme-color-800, #1e40af);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div id="social-links-container" class="flex justify-center space-x-6 mb-4">
                </div>
            <p class="text-white text-sm">&copy; <span id="current-year"></span> Chenglin Pua. Built with Firebase and Tailwind CSS.</p>
        </div>
    </footer>

    <div id="config-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6" style="color: var(--theme-color-700, #3730a3);">Website Configuration</h3>
            <div class="space-y-4">
                <div>
                    <label for="color-picker" class="block text-sm font-medium text-gray-700 mb-2">Primary Theme Color (Tailwind Color Scale)</label>
                    <input type="color" id="color-picker" class="w-full h-10 border border-gray-300 rounded-lg p-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">User ID (For other users to find you)</label>
                    <p id="user-id-display" class="break-all bg-gray-100 p-2 rounded-lg text-sm font-mono"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="saveThemeColor()" class="px-4 py-2 font-medium rounded-lg text-white" style="background-color: var(--theme-color-600, #4f46e5); hover-bg-color: var(--theme-color-700, #3730a3);">
                    Save Settings
                </button>
                <button onclick="document.getElementById('config-modal').classList.add('hidden')" class="px-4 py-2 font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // --- GLOBAL VARIABLES & INITIALIZATION (Identical to Main Page) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isEditMode = false;
        let themeColorHex = '#3B82F6'; 

        const CONFIG_PATH = (uid) => `artifacts/${appId}/users/${uid}/website_settings/settings`;
        const CONTENT_PATH = `artifacts/${appId}/public/data/website_content/main_data`;

        // Updated initialContent (MUST MATCH THE MAIN index.html)
        const initialContent = {
            profile: {
                name: "Chenglin Pua",
                title: "PhD Candidate in Material Science at Tsinghua"
            },
            research: {
                main_intro: "Hello world! I am a PhD candidate (Malaysian) in Materials Science at Tsinghua University, specializing in advanced electron microscopy techniques. My research focuses on scanning transmission electron microscopy (STEM), with a particular emphasis on multi-slice electron ptychography (MEP). Previously, I have worked on the structural analysis of offshore launching platforms during my bachelor‚Äôs studies and conducted atomic-scale characterization of 2D materials.",
                sub_topics: [
                    { 
                        title: "Imaging Lunar Samples", 
                        content: "What do solar flare tracks look like. This project uses advanced STEM imaging to analyze the structural changes in lunar soil caused by solar radiation, providing insights into space weathering processes. The full paper details the methodology and results of the atomic-scale characterization.", 
                        figure_url_long: "https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/research/solar_long_figure.png",
                        journal_link: "https://www.nature.com/articles/lunarsamples",
                        dataset_link: "https://zenodo.org/datasets/lunardata",
                        youtube_link: null
                    },
                    { 
                        title: "Imaging Hydrogen Atoms", 
                        content: "Better atomic scale imaging of hydrogens using Multi-slice Electron Ptychography (MEP). This work is critical for understanding hydrogen storage materials and catalysts. MEP offers high-resolution, phase-retrieved images essential for visualizing light elements like hydrogen.", 
                        figure_url_long: "https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/research/hea_h_long_figure.png",
                        journal_link: "https://www.science.org/doi/10.1126/science.hydrogen",
                        dataset_link: null,
                        youtube_link: "https://www.youtube.com/watch?v=MEP_demo_video"
                    },
                    { 
                        title: "Offshore Launching Platform", 
                        content: "Influence of hydrogen combustion and its mitigation on offshore launch platforms. This is an engineering safety project analyzing structural integrity under extreme conditions.", 
                        figure_url_long: "https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/research/offshore_long_figure.jpg",
                        journal_link: "https://ieeexplore.ieee.org/abstract/offshore_safety",
                        dataset_link: null,
                        youtube_link: null
                    }
                ]
            },
            education: [
                { degree: "Ph.D. in Materials Science", school: "Tsinghua University", years: "2025 - 2028" },
                { degree: "M.S. in Materials Science", school: "Tsinghua University", years: "2022 - 2025" },
                { degree: "B.S. in Mechanical Engineering", school: "Shanghai Jiao Tong University", years: "2018 - 2022" }
            ],
            presentations: [                
                { title: " Simulation analysis and optimization of protective wall against hydrogen combustion from liquified hydrogen storage tank on the offshore launching platform (Oral)", venue: "European Hydrogen Energy Conference, Bilbao Spain", date: "Mar 2024" },
                { title: "xxx", venue: "CEBE 2023, Shanghai, China", date: "Jul 2023" }
            ],
            honors_awards: [
                { title: "Interview from China Daily", year: "2023" },
                { title: "Outstanding Undergraduate Thesis", year: "2022" }
            ],
            personal_life: [
                { title: "Japan Kyoto", content: "It was my first time in Japan, and I was incredibly lucky to meet my idol, Jay Chou, while I was there!", images: ["https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/travel/jay_chou.png","https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/travel/tokyo_japan.jpg"] },
                { title: "USA Silicon Valley", content: "Photos from my trip to Silicon Valley, USA, during November 2024.", images: ["https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/travel/silicon_2.jpg","https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/travel/silicon_1.jpg"] }
            ],
            gallery_albums: [
                { title: "Amazing Nature", type: "photo", items: ["https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/travel/yiheyuan.jpeg", "https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/travel/me.jpeg"] },
                { 
                    title: "3D Atomic Objects", 
                    type: "video", 
                    items: [
                        { 
                            url: "https://www.youtube.com/watch?v=Fw7JEITqc58", 
                            subtitle: "Poly-Si" 
                        },
                        { 
                            url: "https://www.youtube.com/watch?v=3PXx0CkF7Fc", 
                            subtitle: "Lunar Soil" 
                        }
                    ] 
                }
            ],
            articles: [
                { title: "Digital Sweatshops in the AI Era", source: "Lianhe Zaobao, Singapore", link: "https://www.zaobao.com.sg/forum/views/story20250919-7535380" },
                { title: "The Gambler's Fallacy", source: "Sin Chew Daily, Malaysia", link: "https://www.sinchew.com.my/news/20210320/supplement/3144313" }
            ],
            social_links: [
                { name: "ResearchGate", url: "https://www.researchgate.net/profile/Pua-Chenglin/" },
                { name: "Google Scholar", url: "https://scholar.google.com/citations?user=OSv_Bm4AAAAJ&hl=en/" },
                { name: "YouTube", url: "https://www.youtube.com/@AtomiMuseum/" },
                { name: "BiliBili", url: "https://space.bilibili.com/3493105227533275/" },
            ]
        };

        // ====================================================================
        // SHARED UI FUNCTIONS (Identical to Main Page)
        // ====================================================================

        function toggleEditMode(enable) {
            isEditMode = enable;
            const toggleButton = document.getElementById('edit-mode-toggle');
            const editableElements = document.querySelectorAll('.content-editable-field');

            if (isEditMode) {
                toggleButton.textContent = 'Exit Edit Mode';
                toggleButton.classList.remove('bg-white', 'text-gray-800');
                toggleButton.classList.add('bg-red-500', 'text-white');
                editableElements.forEach(el => {
                    el.setAttribute('contenteditable', 'true');
                    el.style.cursor = 'text';
                });
                const configButton = document.createElement('button');
                configButton.id = 'config-btn';
                configButton.innerHTML = '‚öôÔ∏è Config';
                configButton.className = 'px-4 py-2 text-sm font-medium rounded-full bg-yellow-400 text-gray-900 hover:bg-yellow-500 transition duration-150 shadow-md ml-4';
                configButton.onclick = () => document.getElementById('config-modal').classList.remove('hidden');
                document.getElementById('edit-mode-toggle').parentElement.appendChild(configButton);

            } else {
                toggleButton.textContent = 'Enable Edit Mode';
                toggleButton.classList.add('bg-white', 'text-gray-800');
                toggleButton.classList.remove('bg-red-500', 'text-white');
                editableElements.forEach(el => {
                    el.removeAttribute('contenteditable');
                    el.style.cursor = 'default';
                });
                const configBtn = document.getElementById('config-btn');
                if (configBtn) configBtn.remove();
                saveContent();
            }
        }
        
        function renderProfileSidebar(data) {
            const profileContainer = document.getElementById('profile-sidebar-content');
            const profileImageUrl = "https://placehold.co/150x150/1D4ED8/FFFFFF?text=CP"; 
            const profileName = data.profile?.name || initialContent.profile.name;
            const profileTitle = data.profile?.title || initialContent.profile.title;

            profileContainer.innerHTML = `
                <div class="text-center">
                    <img src="${profileImageUrl}" alt="${profileName} Profile Picture" 
                         class="w-24 h-24 rounded-full mx-auto object-cover mb-4 shadow-md" 
                         onerror="this.onerror=null; this.src='https://placehold.co/96x96/1D4ED8/FFFFFF?text=CP';" />
                    
                    <h3 class="text-xl font-bold mb-1 content-editable-field" data-key="profile.name">
                        ${profileName}
                    </h3>
                    <p class="text-sm text-gray-600 mb-4 content-editable-field" data-key="profile.title">
                        ${profileTitle}
                    </p>

                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        ${data.social_links.map(link => {
                            if (['Google Scholar', 'ResearchGate', 'YouTube', 'BiliBili'].includes(link.name)) {
                                return `
                                    <a href="${link.url}" target="_blank" class="flex items-center justify-center text-sm font-medium text-gray-700 hover:text-gray-900 transition duration-150">
                                        ${link.name} &rarr;
                                    </a>
                                `;
                            }
                            return '';
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderSocialLinks(data) {
            const socialContainer = document.getElementById('social-links-container');
            socialContainer.innerHTML = data.social_links.map((link, i) => `
                <a href="${link.url}" target="_blank" class="text-white hover:text-opacity-80 transition duration-150 text-lg font-medium"
                   id="social-${i}-name" data-key="social_links[${i}].name">
                    ${link.name}
                </a>
                <span class="text-white hidden">
                    URL (Edit Mode): <span class="content-editable-field break-all" data-key="social_links[${i}].url">${link.url}</span>
                </span>
            `).join('<span class="text-white">|</span>');
        }

        async function saveContent() {
            if (!db || !userId) return console.error("Database or User ID not initialized for saving.");

            const updatedContent = JSON.parse(JSON.stringify(initialContent));
            const editableElements = document.querySelectorAll('.content-editable-field');

            editableElements.forEach(el => {
                const key = el.dataset.key;
                if (!key) return;

                const value = el.textContent.trim();

                const setNestedProperty = (obj, path, val) => {
                    const parts = path.match(/[^.\[\]]+/g);
                    let current = obj;
                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        if (i === parts.length - 1) {
                            if (path.includes('.images') || path.includes('.items')) {
                                current[part] = val.split(',').map(s => s.trim()).filter(s => s.length > 0);
                            } else {
                                current[part] = val;
                            }
                            return;
                        }

                        let nextPart = parts[i + 1];
                        if (!current[part]) {
                            if (!isNaN(parseInt(nextPart))) {
                                current[part] = [];
                            } else {
                                current[part] = {};
                            }
                        }
                        current = current[part];
                    }
                };
                setNestedProperty(updatedContent, key, value);
            });

            try {
                await setDoc(doc(db, CONTENT_PATH), updatedContent);
                console.log("Website content saved successfully!");
            } catch (error) {
                console.error("Error saving content to Firestore:", error);
                console.warn("Failed to save content. Check the console for details.");
            }
        }

        function applyThemeColor(hexColor) {
            themeColorHex = hexColor;
            const style = document.documentElement.style;
            style.setProperty('--theme-color-500', hexColor);
            style.setProperty('--theme-color-600', hexColor);
            style.setProperty('--theme-color-700', hexColor);
            style.setProperty('--theme-color-800', hexColor);
            document.getElementById('color-picker').value = hexColor;
        }

        async function saveThemeColor() {
            const newColor = document.getElementById('color-picker').value;
            applyThemeColor(newColor);
            document.getElementById('config-modal').classList.add('hidden');

            if (db && userId) {
                try {
                    await setDoc(doc(db, CONFIG_PATH(userId)), { themeColor: newColor }, { merge: true });
                    console.log("Theme color saved successfully!");
                } catch (error) {
                    console.error("Error saving theme color:", error);
                }
            }
        }
        
        // ====================================================================
        // FULL CONTENT RENDER FUNCTIONS (Only used here)
        // ====================================================================

        function renderResearchFull(data) {
            const researchSection = document.getElementById('research-section');
            researchSection.innerHTML = `
                <h2 class="text-4xl font-bold mb-8 text-center" style="color: var(--theme-color-700, #3730a3);">üî¨ Research Overview (Full Academic Portfolio)</h2>

                <div class="bg-white p-8 rounded-xl shadow-xl mb-12">
                    <h3 class="text-2xl font-semibold mb-4" style="color: var(--theme-color-600, #4f46e5);">Introduction</h3>
                    <p id="research-main-intro" class="text-gray-600 leading-relaxed min-h-[50px] content-editable-field" data-key="research.main_intro">
                        ${data.research.main_intro || initialContent.research.main_intro}
                    </p>
                </div>

                <h3 class="text-3xl font-bold mb-6" style="color: var(--theme-color-700, #3730a3);">Detailed Projects</h3>

                <div class="space-y-12" id="research-sub-topics">
                    ${data.research.sub_topics.map((topic, i) => `
                        <div class="bg-white p-8 rounded-xl shadow-xl border-t-4" style="border-top-color: var(--theme-color-500, #3b82f6);">
                            
                            <h4 class="text-2xl font-bold mb-4 content-editable-field" style="color: var(--theme-color-600, #4f46e5);"
                                id="research-sub-topics-${i}-title" data-key="research.sub_topics[${i}].title">
                                ${topic.title}
                            </h4>

                            <p class="text-gray-700 leading-relaxed mb-6 content-editable-field min-h-[50px]"
                                id="research-sub-topics-${i}-content" data-key="research.sub_topics[${i}].content">
                                ${topic.content}
                            </p>

                            ${topic.figure_url_long ? `
                                <div class="mb-6">
                                    <h5 class="text-lg font-semibold mb-2 text-gray-700">Project Figure (PPT Longstyle)</h5>
                                    <div class="figure-longstyle w-full aspect-16-4 rounded-lg overflow-hidden shadow-xl magnify-on-hover">
                                        <img src="${topic.figure_url_long}" alt="${topic.title} long-style figure" 
                                            onerror="this.onerror=null; this.src='https://placehold.co/1200x300/1D4ED8/FFFFFF?text=PPT+LONGSTYLE+FIGURE';" />
                                    </div>
                                    <p class="mt-2 text-sm text-gray-500">
                                        Figure URL: <span class="content-editable-field break-all" data-key="research.sub_topics[${i}].figure_url_long">${topic.figure_url_long || ''}</span>
                                    </p>
                                </div>
                            ` : ''}
                            
                            <div class="flex flex-wrap gap-3 mt-6 border-t pt-4 border-gray-100">
                                ${topic.journal_link ? `
                                    <a href="${topic.journal_link}" target="_blank" 
                                        class="px-4 py-2 text-sm font-medium rounded-full bg-blue-500 text-white hover:bg-blue-600 transition duration-150 shadow-md">
                                        üìÑ View Academic Paper
                                    </a>
                                ` : ''}
                                ${topic.dataset_link ? `
                                    <a href="${topic.dataset_link}" target="_blank" 
                                        class="px-4 py-2 text-sm font-medium rounded-full bg-green-500 text-white hover:bg-green-600 transition duration-150 shadow-md">
                                        üíæ Access Dataset
                                    </a>
                                ` : ''}
                                ${topic.youtube_link ? `
                                    <a href="${topic.youtube_link}" target="_blank" 
                                        class="px-4 py-2 text-sm font-medium rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">
                                        ‚ñ∂Ô∏è Watch YouTube Demo (MEP)
                                    </a>
                                ` : ''}
                            </div>
                            <div class="mt-4 text-sm text-gray-500 space-y-1 hidden">
                                <p>Journal Link: <span class="content-editable-field break-all" data-key="research.sub_topics[${i}].journal_link">${topic.journal_link || ''}</span></p>
                                <p>Dataset Link: <span class="content-editable-field break-all" data-key="research.sub_topics[${i}].dataset_link">${topic.dataset_link || ''}</span></p>
                                <p>YouTube Link: <span class="content-editable-field break-all" data-key="research.sub_topics[${i}].youtube_link">${topic.youtube_link || ''}</span></p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ====================================================================
        // PAGE INITIALIZATION (Specific to research/index.html)
        // ====================================================================

        function initPage(data) {
            if (!data) data = initialContent; 
            
            // 1. Render Global Components
            renderProfileSidebar(data); 
            renderSocialLinks(data);

            // 2. Render only the FULL content for this page
            document.getElementById('research-section').classList.remove('hidden');
            renderResearchFull(data);

            // 3. Hide loading and apply edit mode
            document.getElementById('loading-indicator').classList.add('hidden');
            
            // 4. Re-apply edit mode (since renderResearchFull overwrites the innerHTML)
            if (isEditMode) {
                document.querySelectorAll('.content-editable-field').forEach(el => {
                    el.setAttribute('contenteditable', 'true');
                    el.parentElement.classList.remove('hidden'); // Show hidden link fields
                });
            }
        }

        // ====================================================================
        // FIREBASE & APP SETUP (Identical to Main Page)
        // ====================================================================

        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing or empty.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    userId = user ? user.uid : null;
                    document.getElementById('user-id-display').textContent = userId || 'N/A';

                    onSnapshot(doc(db, CONTENT_PATH), (docSnap) => {
                        const content = docSnap.exists() ? docSnap.data() : initialContent;
                        initPage(content); 
                        if (!docSnap.exists()) {
                            setDoc(doc(db, CONTENT_PATH), initialContent).catch(e => console.error("Error writing initial content:", e));
                        }
                    }, (error) => {
                        console.error("Error listening to public content:", error);
                        initPage(initialContent);
                    });

                    if (userId) {
                        onSnapshot(doc(db, CONFIG_PATH(userId)), (docSnap) => {
                            if (docSnap.exists() && docSnap.data().themeColor) {
                                applyThemeColor(docSnap.data().themeColor);
                            } else {
                                applyThemeColor(themeColorHex); 
                            }
                        }, (error) => {
                            console.warn("Could not load private settings, using default theme.", error);
                            applyThemeColor(themeColorHex);
                        });
                    }
                });

                document.getElementById('edit-mode-toggle').addEventListener('click', () => {
                    if (userId) {
                        toggleEditMode(!isEditMode);
                    } else {
                        console.warn("Cannot enable Edit Mode. Authentication failed or user is not recognized as the owner.");
                    }
                });

            } catch (error) {
                document.getElementById('loading-indicator').innerHTML = `
                    <p class="text-red-600 text-lg">Error Initializing Firebase:</p>
                    <p class="text-red-500 text-sm mt-2">The application could not load its content database. Please check console for details.</p>
                `;
                console.error("Firebase initialization failed:", error);
                initPage(initialContent);
            }
        }

        document.getElementById('current-year').textContent = new Date().getFullYear();
        initializeFirebase();
        window.saveThemeColor = saveThemeColor;
        window.addEventListener('beforeunload', () => {
            if (isEditMode) {
                saveContent();
            }
        });
    </script>
</body>
</html>
